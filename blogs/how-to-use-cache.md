# å¦‚ä½•æ­£ç¡®ä½¿ç”¨ç¼“å­˜ï¼šå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

## å‰è¨€

ç¼“å­˜ï¼ˆRedis/Memcacheï¼‰æ˜¯æå‡ç³»ç»Ÿæ€§èƒ½çš„åˆ©å™¨ï¼Œä½†é”™è¯¯çš„ä½¿ç”¨æ–¹å¼ä¸ä»…æ— æ³•å¸¦æ¥æ€§èƒ½æå‡ï¼Œåè€Œä¼šå¼•å…¥æ›´å¤šé—®é¢˜ã€‚æœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹å’Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œå¸®åŠ©åˆçº§å¼€å‘è€…ç†è§£ç¼“å­˜ä½¿ç”¨çš„å¸¸è§è¯¯åŒºå’Œæ­£ç¡®å§¿åŠ¿ã€‚

## ä¸€ã€å¸¸è§çš„ç¼“å­˜è¯¯ç”¨æ¨¡å¼

### 1.1 é”™è¯¯æ¡ˆä¾‹ï¼šç›´æ¥ç¼“å­˜åˆ†é¡µç»“æœ

å¾ˆå¤šæ–°æ‰‹å¼€å‘è€…ä¼šç›´æ¥ç¼“å­˜åˆ†é¡µæŸ¥è¯¢çš„ç»“æœï¼Œä¾‹å¦‚ï¼š

```go
// âŒ é”™è¯¯åšæ³•
func GetUserFollowers(userID int64, page, pageSize int) ([]User, error) {
    cacheKey := fmt.Sprintf("followers:%d:%d:%d", userID, page, pageSize)
    
    // å°è¯•ä»ç¼“å­˜è·å–
    if cached := cache.Get(cacheKey); cached != nil {
        return cached, nil
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    followers := db.Query("SELECT * FROM users WHERE ... LIMIT ? OFFSET ?", 
                          pageSize, page*pageSize)
    
    // å°†æ•´é¡µç»“æœç¼“å­˜
    cache.Set(cacheKey, followers, 3600)
    return followers, nil
}
```

**è¿™ç§åšæ³•æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

### 1.2 æ ¸å¿ƒé—®é¢˜ï¼šå†…å­˜çˆ†ç‚¸å’Œä¸€è‡´æ€§å™©æ¢¦

å‡è®¾ä¸€ä¸ªç”¨æˆ·æœ‰ 20,000 ä¸ªç²‰ä¸ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä»¥ä¸åŒçš„åˆ†é¡µå‚æ•°è¯·æ±‚ï¼š

```
followers:123:1:20   â†’ ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
followers:123:2:20   â†’ ç¬¬2é¡µï¼Œæ¯é¡µ20æ¡
followers:123:1:50   â†’ ç¬¬1é¡µï¼Œæ¯é¡µ50æ¡
followers:123:1:100  â†’ ç¬¬1é¡µï¼Œæ¯é¡µ100æ¡
...
```

#### é—®é¢˜1ï¼šå†…å­˜æˆæœ¬ä¸å¯æ§ï¼ˆè‡´å‘½ï¼‰

**å†…å­˜æ˜¯æœ‰é™çš„ã€æ˜‚è´µçš„èµ„æºã€‚**

```
è®¡ç®—ï¼š20,000ä¸ªç²‰ä¸ï¼Œæ¯ä¸ªç”¨æˆ·æ•°æ®500å­—èŠ‚

å¯èƒ½çš„åˆ†é¡µç»„åˆï¼š
- page: 1-1000ï¼ˆæ·±åº¦åˆ†é¡µï¼‰
- pageSize: 10, 20, 50, 100
- ä¸åŒæ’åº: å…³æ³¨æ—¶é—´ã€æ´»è·ƒåº¦

ä¿å®ˆä¼°è®¡100ç§ç»„åˆï¼š
100 Ã— 20æ¡/é¡µ Ã— 500å­—èŠ‚ = 1MBï¼ˆåªæ˜¯ç¬¬1é¡µçš„å„ç§å˜ä½“ï¼‰
100 Ã— 1000é¡µ Ã— 20æ¡ Ã— 500å­—èŠ‚ = 1GBï¼ˆæ‰€æœ‰åˆ†é¡µç»„åˆï¼‰

ä¸€ä¸ªç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨å°±èƒ½å ç”¨GBçº§ç¼“å­˜ï¼
10ä¸‡ç”¨æˆ· Ã— 1GB = 100TBç¼“å­˜ â† å®Œå…¨ä¸å¯è¡Œ
```

**å†…å­˜æˆæœ¬å¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | å•ç”¨æˆ·æŸ¥è¯¢ | 1ä¸‡äººæŸ¥è¯¢ | 10ä¸‡äººæŸ¥è¯¢ |
|------|-----------|---------|----------|
| ç¼“å­˜åˆ—è¡¨ | ~1GB | 10TB | 100TB âŒ |
| ç¼“å­˜å®ä½“ï¼ˆIDç´¢å¼•ï¼‰ | ~10MB | ~10MB | ~10MB âœ“ |
| ç¼“å­˜å®ä½“ï¼ˆUserå¯¹è±¡å…±äº«ï¼‰ | å–å†³äºç³»ç»Ÿæ€»ç”¨æˆ·æ•°ï¼Œä¸æ˜¯æŸ¥è¯¢ç”¨æˆ·æ•° | | |

**å…³é”®åŒºåˆ«ï¼š**
- **ç¼“å­˜åˆ—è¡¨**ï¼šå†…å­˜éš"æŸ¥è¯¢çš„ç”¨æˆ·æ•°"çº¿æ€§å¢é•¿ï¼ˆ10ä¸‡äººæŸ¥ = 100TBï¼‰
- **ç¼“å­˜å®ä½“**ï¼šå†…å­˜åªå’Œ"ç³»ç»Ÿä¸­çš„å®ä½“æ€»æ•°"æœ‰å…³ï¼Œä¸æŸ¥è¯¢äººæ•°æ— å…³
  - å‡è®¾ç³»ç»Ÿæœ‰ 100ä¸‡ä¸ªç”¨æˆ·å®ä½“ï¼Œæ¯ä¸ª 500å­—èŠ‚
  - æ€»å†…å­˜ = 100ä¸‡ Ã— 500å­—èŠ‚ = **500MB**ï¼ˆå›ºå®šï¼‰
  - æ— è®º1ä¸ªäººæŸ¥è¿˜æ˜¯10ä¸‡äººæŸ¥ï¼ŒUserå®ä½“éƒ½æ˜¯å…±äº«çš„

**å®ä½“å…±äº«ç¤ºä¾‹ï¼š**
```
User#5 çš„æ•°æ®åœ¨Redisä¸­åªå­˜1ä»½ï¼š
user:5 â†’ {"id":5, "name":"Alice", ...}  (500å­—èŠ‚)

ä½†è¢«Nä¸ªåˆ—è¡¨å¼•ç”¨ï¼š
- follower_ids:123 â†’ [..., 5, ...]  (User Açš„ç²‰ä¸)
- follower_ids:456 â†’ [..., 5, ...]  (User Bçš„ç²‰ä¸)
- following_ids:789 â†’ [..., 5, ...]  (User Cçš„å…³æ³¨)
- recommend:999 â†’ [..., 5, ...]     (æ¨èåˆ—è¡¨)

â†’ 1ä»½æ•°æ®ï¼Œæ— æ•°æ¬¡å¤ç”¨ï¼
```

è¿™å°±æ˜¯å®ä½“ç¼“å­˜çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**å†…å­˜å ç”¨å¯é¢„æµ‹ä¸”å¯æ§ã€‚**

#### é—®é¢˜2ï¼šæ•°æ®ä¸€è‡´æ€§æ— æ³•ä¿è¯ï¼ˆæ›´è‡´å‘½ï¼‰

è¿™æ˜¯æ›´ä¸¥é‡çš„é—®é¢˜ï¼š**å½“æ•°æ®æ›´æ–°æ—¶ï¼Œä½ ä¸çŸ¥é“è¯¥æ¸…ç†å“ªäº›ç¼“å­˜é”®ã€‚**

**åœºæ™¯ï¼šUser#5 ä¿®æ”¹äº†æ˜µç§°**

```
éœ€è¦æ¸…ç†çš„ç¼“å­˜ï¼ˆä½ èƒ½æ‰¾å…¨å—ï¼Ÿï¼‰ï¼š
followers:123:1:20     â† User#5åœ¨è¿™é‡Œå—ï¼Ÿ
followers:123:1:50     â† User#5åœ¨è¿™é‡Œå—ï¼Ÿ
followers:123:2:20     â† User#5åœ¨è¿™é‡Œå—ï¼Ÿ
followers:456:1:20     â† User#5æ˜¯456çš„ç²‰ä¸å—ï¼Ÿ
following:789:3:50     â† User#5å…³æ³¨äº†789å—ï¼Ÿ
recommend_users:100:1:20  â† æ¨èåˆ—è¡¨é‡Œæœ‰User#5å—ï¼Ÿ
search_result:query1:1:20 â† æœç´¢ç»“æœæœ‰User#5å—ï¼Ÿ
... æˆç™¾ä¸Šåƒä¸ªå¯èƒ½åŒ…å«User#5çš„åˆ—è¡¨
```

**ä½ æ— æ³•ç²¾ç¡®çŸ¥é“User#5å‡ºç°åœ¨å“ªäº›åˆ—è¡¨ç¼“å­˜ä¸­ï¼**

**ä¸‰ç§é”™è¯¯çš„"è§£å†³"æ–¹æ¡ˆï¼š**

```go
// æ–¹æ¡ˆAï¼šå…¨éƒ¨æ¸…ç©ºï¼ˆâŒ ç¼“å­˜é›ªå´©ï¼‰
cache.FlushAll()  // æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰ç¼“å­˜éƒ½å¤±æ•ˆï¼Œæ•°æ®åº“ç¬é—´è¢«æ‰“å®

// æ–¹æ¡ˆBï¼šæ¨¡ç³Šåˆ é™¤ï¼ˆâŒ æ€§èƒ½å·® + ä¸å®‰å…¨ï¼‰
cache.DeletePattern("followers:*")  // KEYSå‘½ä»¤ä¼šé˜»å¡Redis
cache.DeletePattern("following:*")
cache.DeletePattern("recommend_*")
// 1. KEYS * åœ¨ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ï¼ˆé˜»å¡æ‰€æœ‰æ“ä½œï¼‰
// 2. ä»ç„¶ä¼šæ¼æ‰ä¸€äº›ç¼“å­˜ï¼ˆå¦‚search_resultï¼‰

// æ–¹æ¡ˆCï¼šç»´æŠ¤åå‘ç´¢å¼•ï¼ˆâŒ å¤æ‚åº¦çˆ†ç‚¸ï¼‰
// ç»´æŠ¤ä¸€ä¸ªæ˜ å°„ï¼šuser:5 â†’ [æ‰€æœ‰åŒ…å«user5çš„ç¼“å­˜é”®]
cache.Set("user:5:in_lists", [
    "followers:123:1:20",
    "followers:123:2:20",
    ...  // éœ€è¦å®æ—¶ç»´æŠ¤è¿™ä¸ªåˆ—è¡¨ï¼Œå·¥ç¨‹å™©æ¢¦
])
```

**çœŸå®æ¡ˆä¾‹ï¼š**

```
æŸç”µå•†ç½‘ç«™ç¼“å­˜å•†å“åˆ—è¡¨ï¼š
- é¦–é¡µæ¨èï¼šcached
- åˆ†ç±»åˆ—è¡¨ï¼šcached  
- æœç´¢ç»“æœï¼šcached
- ä¿ƒé”€æ´»åŠ¨ï¼šcached

æŸå•†å“ä¿®æ”¹ä»·æ ¼åï¼š
- å¿˜è®°æ¸…ç†æœç´¢ç»“æœç¼“å­˜ â†’ ç”¨æˆ·æœç´¢çœ‹åˆ°æ—§ä»·æ ¼
- å¿˜è®°æ¸…ç†æ´»åŠ¨é¡µç¼“å­˜ â†’ ä¸‹å•æ—¶å‘ç°ä»·æ ¼ä¸ä¸€è‡´
- æŠ•è¯‰ã€é€€æ¬¾ã€ä¸šåŠ¡æŸå¤±

æœ€åä¸å¾—ä¸ï¼š
1. å®šæ—¶å…¨é‡åˆ·æ–°ç¼“å­˜ï¼ˆæµªè´¹èµ„æºï¼‰
2. ç¼©çŸ­TTLåˆ°5åˆ†é’Ÿï¼ˆç¼“å­˜æ•ˆæœå¤§æ‰“æŠ˜æ‰£ï¼‰
3. æ¥å—æ•°æ®ä¸ä¸€è‡´ï¼ˆæŸå®³ç”¨æˆ·ä½“éªŒï¼‰
```

**ä¸ºä»€ä¹ˆç¼“å­˜å®ä½“å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ**

```
å½“User#5ä¿®æ”¹æ˜µç§°ï¼š
åªéœ€åˆ é™¤: user:5  â† åªæœ‰1ä¸ªé”®ï¼

æ‰€æœ‰å¼•ç”¨User#5çš„åˆ—è¡¨ï¼š
- followers:123 â†’ å­˜çš„æ˜¯IDåˆ—è¡¨ [1,2,3,5,...]ï¼Œä¸éœ€è¦æ¸…ç†
- ä¸‹æ¬¡æŸ¥è¯¢æ—¶ä¼šè‡ªåŠ¨è·å–æœ€æ–°çš„ user:5 æ•°æ®

æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯ï¼Œç»´æŠ¤æˆæœ¬æä½ã€‚
```

### 1.3 å›¾ç¤ºï¼šç¼“å­˜é”®çˆ†ç‚¸

```
ç”¨æˆ·123çš„ç²‰ä¸åˆ—è¡¨ï¼ˆ20,000äººï¼‰

é”™è¯¯çš„ç¼“å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  followers:123:1:20  â†’ [User1..User20]  â”‚  â† é‡å¤å­˜å‚¨User1-20
â”‚  followers:123:1:50  â†’ [User1..User50]  â”‚  â† é‡å¤å­˜å‚¨User1-20
â”‚  followers:123:2:20  â†’ [User21..User40] â”‚
â”‚  followers:123:1:100 â†’ [User1..User100] â”‚  â† é‡å¤å­˜å‚¨User1-20
â”‚  ... æ•°ç™¾ä¸ªç±»ä¼¼çš„é”®                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“User1æ›´æ–°èµ„æ–™æ—¶ï¼Œéœ€è¦æ¸…ç†æ‰€æœ‰åŒ…å«User1çš„ç¼“å­˜é”®ï¼
```

## äºŒã€æ­£ç¡®çš„ç¼“å­˜ç­–ç•¥

### 2.1 åŸåˆ™ï¼šç¼“å­˜å®ä½“ï¼Œè€ŒéæŸ¥è¯¢ç»“æœ

æ­£ç¡®çš„åšæ³•æ˜¯**ç¼“å­˜æœ€å°ç²’åº¦çš„å®ä½“**ï¼Œç„¶ååœ¨åº”ç”¨å±‚ç»„è£…ã€‚

```go
// âœ… æ­£ç¡®åšæ³•
type FollowerService struct {
    cache Cache
    db    Database
}

// ç¼“å­˜ç²‰ä¸IDåˆ—è¡¨ï¼ˆç´¢å¼•ï¼‰ - ä½¿ç”¨Redis List
func (s *FollowerService) cacheFollowerIDs(userID int64) error {
    cacheKey := fmt.Sprintf("follower_ids:%d", userID)
    
    // æŸ¥è¯¢æ‰€æœ‰ç²‰ä¸ID
    ids := s.db.Query("SELECT follower_id FROM follows WHERE user_id = ? ORDER BY created_at DESC", userID)
    
    // å­˜ä¸ºRedis Listï¼ˆè€ŒéJSONï¼‰
    s.cache.Del(cacheKey)
    s.cache.RPush(cacheKey, ids...)  // æ‰¹é‡æ’å…¥
    s.cache.Expire(cacheKey, 3600)
    return nil
}

// ç›´æ¥è·å–æŒ‡å®šèŒƒå›´çš„ç²‰ä¸ID
func (s *FollowerService) getFollowerIDRange(userID int64, start, end int) ([]int64, error) {
    cacheKey := fmt.Sprintf("follower_ids:%d", userID)
    
    // ä½¿ç”¨LRANGEç›´æ¥è·å–èŒƒå›´å†…çš„IDï¼ˆä¸éœ€è¦å…¨éƒ¨åŠ è½½ï¼ï¼‰
    ids := s.cache.LRange(cacheKey, start, end)
    
    if len(ids) == 0 {
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆå§‹åŒ–ç¼“å­˜
        s.cacheFollowerIDs(userID)
        ids = s.cache.LRange(cacheKey, start, end)
    }
    
    return ids, nil
}

// æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
func (s *FollowerService) getUsersByIDs(ids []int64) ([]User, error) {
    if len(ids) == 0 {
        return []User{}, nil
    }
    
    // 1. æ‰¹é‡æ„é€ ç¼“å­˜é”®
    cacheKeys := make([]string, len(ids))
    for i, id := range ids {
        cacheKeys[i] = fmt.Sprintf("user:%d", id)
    }
    
    // 2. ä½¿ç”¨ MGET æ‰¹é‡è·å–ç¼“å­˜ï¼ˆå•æ¬¡ç½‘ç»œå¾€è¿”ï¼ï¼‰
    cachedValues := s.cache.MGet(cacheKeys...)
    
    // 3. è§£æç¼“å­˜ç»“æœï¼Œæ”¶é›†æœªå‘½ä¸­çš„ID
    cached := make(map[int64]User)
    missingIDs := make([]int64, 0)
    
    for i, val := range cachedValues {
        if val != nil {
            var user User
            json.Unmarshal([]byte(val.(string)), &user)
            cached[ids[i]] = user
        } else {
            missingIDs = append(missingIDs, ids[i])
        }
    }
    
    // 4. æ‰¹é‡æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­çš„ç”¨æˆ·
    if len(missingIDs) > 0 {
        dbUsers := s.db.Query("SELECT * FROM users WHERE id IN (?)", missingIDs)
        
        // æ‰¹é‡å›å†™ç¼“å­˜ï¼ˆä½¿ç”¨Pipelineï¼‰
        pipe := s.cache.Pipeline()
        for _, user := range dbUsers {
            cached[user.ID] = user
            data, _ := json.Marshal(user)
            pipe.Set(ctx, fmt.Sprintf("user:%d", user.ID), data, 3600*time.Second)
        }
        pipe.Exec(ctx)  // ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰SET
    }
    
    // 5. æŒ‰åŸå§‹IDé¡ºåºè¿”å›ç»“æœ
    users := make([]User, 0, len(ids))
    for _, id := range ids {
        if user, ok := cached[id]; ok {
            users = append(users, user)
        }
    }
    
    return users, nil
}

// åˆ†é¡µè·å–ç²‰ä¸ï¼ˆåº”ç”¨å±‚ç»„è£…ï¼‰
func (s *FollowerService) GetFollowers(userID int64, page, pageSize int) ([]User, error) {
    // 1. è®¡ç®—èŒƒå›´
    start := page * pageSize
    end := start + pageSize - 1
    
    // 2. ç›´æ¥è·å–è¿™ä¸€é¡µçš„ç²‰ä¸IDï¼ˆä½¿ç”¨LRANGEï¼Œä¸åŠ è½½å…¨éƒ¨ï¼ï¼‰
    pageIDs, err := s.getFollowerIDRange(userID, start, end)
    if err != nil {
        return nil, err
    }
    
    // 3. æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆåˆ©ç”¨å®ä½“ç¼“å­˜ï¼‰
    return s.getUsersByIDs(pageIDs)
}
```

### 2.2 æ€§èƒ½é™·é˜±ï¼šJSONååºåˆ—åŒ–çš„éšè—æˆæœ¬

åœ¨å®ç°ç´¢å¼•+å®ä½“æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚

**âŒ é”™è¯¯çš„å®ç°ï¼ˆåˆç‰ˆï¼‰ï¼š**

```go
// å°†ç´¢å¼•å­˜ä¸ºJSON
func cacheIndex(userID string, ids []string) {
    data, _ := json.Marshal(ids)  // 10,000ä¸ªIDåºåˆ—åŒ–æˆJSON
    redis.Set("follower_ids:"+userID, data)
}

func getFollowers(userID string, page, size int) {
    // æ¯æ¬¡è¯·æ±‚éƒ½è¿™æ ·åšï¼š
    data := redis.Get("follower_ids:" + userID)
    var allIDs []string
    json.Unmarshal(data, &allIDs)  // â† ååºåˆ—åŒ–10,000ä¸ªIDï¼
    
    // ç„¶ååˆ‡ç‰‡
    start := page * size
    pageIDs := allIDs[start:start+size]
    
    return getUsersByIDs(pageIDs)
}
```

**æ€§èƒ½æµ‹è¯•ç»“æœï¼š**
```
å¹³å‡å»¶è¿Ÿ: 5.0ms  â† å¤ªæ…¢äº†ï¼
```

**é—®é¢˜åˆ†æï¼š**
```
æ¯æ¬¡æŸ¥è¯¢ç¬¬1é¡µï¼ˆ20ä¸ªç”¨æˆ·ï¼‰ï¼š
1. Redis GET: å‡ ç™¾KBçš„JSONæ•°æ® â†’ 100Âµs
2. JSONååºåˆ—åŒ–10,000ä¸ªID â†’ 4ms âŒ ç“¶é¢ˆï¼
3. åº”ç”¨å±‚åˆ‡ç‰‡è·å–20ä¸ªID â†’ 1Âµs
4. Redis MGET 20ä¸ªç”¨æˆ· â†’ 300Âµs
æ€»è®¡ï¼š5ms

åªéœ€è¦20ä¸ªIDï¼Œå´ååºåˆ—åŒ–äº†10,000ä¸ªï¼
```

**âœ… æ­£ç¡®çš„å®ç°ï¼ˆä¼˜åŒ–åï¼‰ï¼š**

```go
// ä½¿ç”¨Redis Listå­˜å‚¨ç´¢å¼•
func cacheIndex(userID string, ids []string) {
    redis.Del("follower_ids:" + userID)
    redis.RPush("follower_ids:"+userID, ids...)  // å­˜ä¸ºList
}

func getFollowers(userID string, page, size int) {
    // ç›´æ¥è·å–éœ€è¦çš„èŒƒå›´
    start := page * size
    end := start + size - 1
    
    pageIDs := redis.LRange("follower_ids:"+userID, start, end)  // â† åªè·å–20ä¸ªï¼
    
    return getUsersByIDs(pageIDs)
}
```

**ä¼˜åŒ–åçš„æ€§èƒ½ï¼š**
```
å¹³å‡å»¶è¿Ÿ: 518Âµs  â† æå‡äº†10å€ï¼
```

**ä¸ºä»€ä¹ˆå¿«äº†ï¼Ÿ**
```
æŸ¥è¯¢ç¬¬1é¡µï¼ˆ20ä¸ªç”¨æˆ·ï¼‰ï¼š
1. Redis LRANGE 0-19: åªè¿”å›20ä¸ªID â†’ 100Âµs âœ“
2. æ— éœ€ååºåˆ—åŒ– â†’ 0Âµs âœ“
3. Redis MGET 20ä¸ªç”¨æˆ· â†’ 300Âµs
4. åº”ç”¨å±‚ç»„è£… â†’ 100Âµs
æ€»è®¡ï¼š518Âµs
```

**ç»éªŒæ€»ç»“ï¼š**

| åœºæ™¯ | é”™è¯¯åšæ³• | æ­£ç¡®åšæ³• | æ€§èƒ½å·®å¼‚ |
|------|---------|---------|---------|
| å¤§æ•°ç»„ç´¢å¼• | JSONåºåˆ—åŒ–å…¨éƒ¨ | Redis List + LRANGE | 10å€ |
| æœ‰åºé›†åˆ | JSONæ•°ç»„ | Redis ZSet + ZRANGE | ç±»ä¼¼ |
| æ— åºé›†åˆ | JSONæ•°ç»„ | Redis Set + SRANDMEMBER | ç±»ä¼¼ |

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. âŒ ä¸è¦ç”¨JSONå­˜å‚¨å¤§æ•°ç»„/å¤§é›†åˆ
2. âœ… ä¼˜å…ˆä½¿ç”¨RedisåŸç”Ÿæ•°æ®ç»“æ„ï¼ˆList/Set/ZSetï¼‰
3. âœ… åªå–éœ€è¦çš„æ•°æ®ï¼Œä¸è¦"å…¨éƒ¨åŠ è½½å†åˆ‡ç‰‡"

**Redis vs Memcacheï¼š**

è¿™ä¸ªæ¡ˆä¾‹ä¹Ÿè¯´æ˜äº†ä¸ºä»€ä¹ˆ **Redis æ¯” Memcache æ›´é€‚åˆç°ä»£åº”ç”¨**ï¼š

| ç‰¹æ€§ | Memcache | Redis |
|------|----------|-------|
| æ•°æ®ç»“æ„ | åªæœ‰ Stringï¼ˆå¿…é¡»åºåˆ—åŒ–ï¼‰ | List/Set/ZSet/Hash/String |
| èŒƒå›´æŸ¥è¯¢ | âŒ å¿…é¡»å…¨éƒ¨è¯»å–å†åˆ‡ç‰‡ | âœ“ LRANGE/ZRANGE ç›´æ¥è·å– |
| å†…å­˜æ•ˆç‡ | ä½ï¼ˆé‡å¤åºåˆ—åŒ–ï¼‰ | é«˜ï¼ˆåŸç”Ÿæ•°æ®ç»“æ„ï¼‰ |
| æ€§èƒ½ | æ…¢ï¼ˆJSONååºåˆ—åŒ–å¼€é”€ï¼‰ | å¿«ï¼ˆæ— éœ€ååºåˆ—åŒ–ï¼‰ |

**Memcacheçš„å›°å¢ƒï¼š**
```go
// Memcacheåªèƒ½è¿™æ ·åšï¼š
data := memcache.Get("follower_ids:123")
var allIDs []int64
json.Unmarshal(data, &allIDs)  // â† å¿…é¡»ååºåˆ—åŒ–å…¨éƒ¨ï¼
pageIDs := allIDs[start:end]   // â† ç„¶ååˆ‡ç‰‡
```

**Redisçš„ä¼˜åŠ¿ï¼š**
```go
// Rediså¯ä»¥ç›´æ¥è·å–èŒƒå›´
pageIDs := redis.LRange("follower_ids:123", start, end)  // â† ä¸€æ­¥åˆ°ä½ï¼
```

**ç»“è®ºï¼šå¯¹äºåˆ—è¡¨ã€é›†åˆã€æ’è¡Œæ¦œç­‰åœºæ™¯ï¼Œä¼˜å…ˆé€‰æ‹©Redisã€‚**

### 2.3 å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨ MGET æ‰¹é‡æŸ¥è¯¢

**âŒ å¸¸è§é”™è¯¯ï¼šå¾ªç¯æŸ¥è¯¢Redis**

```go
// é”™è¯¯ç¤ºä¾‹ï¼šNæ¬¡ç½‘ç»œå¾€è¿”
for _, id := range userIDs {
    key := fmt.Sprintf("user:%d", id)
    user := cache.Get(key)  // æ¯æ¬¡éƒ½æ˜¯ä¸€æ¬¡ç½‘ç»œè¯·æ±‚ï¼
    users = append(users, user)
}
```

**æ€§èƒ½å½±å“ï¼š**
- å‡è®¾æŸ¥è¯¢100ä¸ªç”¨æˆ·ï¼Œæ¯æ¬¡Rediså¾€è¿” 0.5ms
- æ€»è€—æ—¶ï¼š100 Ã— 0.5ms = **50ms**
- å¯¹äºæœ¬åœ°Rediså¯èƒ½è¿˜å¥½ï¼Œä½†è·¨æœºæˆ¿ç½‘ç»œå¾€è¿”ä¼šæ›´æ…¢

**âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ MGET**

```go
// ä¸€æ¬¡ç½‘ç»œå¾€è¿”è·å–æ‰€æœ‰æ•°æ®
keys := []string{"user:1", "user:2", ..., "user:100"}
values := cache.MGet(keys...)  // å•æ¬¡ç½‘ç»œè¯·æ±‚ï¼
// æ€»è€—æ—¶ï¼š1 Ã— 0.5ms = 0.5ms
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

| æŸ¥è¯¢æ–¹å¼ | ç½‘ç»œå¾€è¿” | å»¶è¿Ÿï¼ˆ100ä¸ªkeyï¼‰ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------------|---------|
| å¾ªç¯ GET | Næ¬¡ | ~50ms (æœ¬åœ°), >500ms (è·¨æœºæˆ¿) | âŒ æ°¸è¿œä¸è¦ç”¨ |
| MGET | 1æ¬¡ | ~0.5ms (æœ¬åœ°), ~5ms (è·¨æœºæˆ¿) | âœ… æ‰¹é‡æŸ¥è¯¢å¿…é€‰ |

**å®é™…é¡¹ç›®ä¸­çš„å·®å¼‚ï¼š**
```
æŸ¥è¯¢20ä¸ªç²‰ä¸ä¿¡æ¯ï¼š
å¾ªç¯GETï¼š  20 Ã— 0.5ms = 10ms
MGETï¼š     1 Ã— 0.5ms  = 0.5ms   â† å¿«20å€ï¼

æŸ¥è¯¢100ä¸ªæ¨èç”¨æˆ·ï¼ˆè·¨æœºæˆ¿ï¼‰ï¼š
å¾ªç¯GETï¼š  100 Ã— 5ms = 500ms   â† æ¥å£è¶…æ—¶é£é™©
MGETï¼š     1 Ã— 5ms   = 5ms     â† å¯æ¥å—
```

**é‡è¦æé†’ï¼š**
- Redisçš„ `MGET` / `MSET` æ˜¯åŸå­æ“ä½œ
- Memcache ä½¿ç”¨ `GetMulti`
- Pipeline ä¹Ÿèƒ½å‡å°‘å¾€è¿”ï¼Œä½†ä¸å¦‚MGETæ–¹ä¾¿

### 2.4 ä¼˜åŒ–åçš„ç¼“å­˜ç»“æ„

```
æ­£ç¡®çš„ç¼“å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  follower_ids:123 â†’ [1,2,3,...20000]â”‚  â† åªå­˜ä¸€æ¬¡IDåˆ—è¡¨
â”‚                                      â”‚
â”‚  user:1 â†’ {id:1, name:"Alice", ...} â”‚  â† å®ä½“çº§ç¼“å­˜
â”‚  user:2 â†’ {id:2, name:"Bob", ...}   â”‚
â”‚  user:3 â†’ {id:3, name:"Charlie",...}â”‚
â”‚  ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
1. ä»»ä½•åˆ†é¡µå‚æ•°éƒ½èƒ½å¤ç”¨åŒä¸€ä»½IDç´¢å¼•
2. ç”¨æˆ·å®ä½“åœ¨å¤šå¤„ä½¿ç”¨ï¼ˆå…³æ³¨åˆ—è¡¨ã€æ¨èã€æœç´¢ï¼‰éƒ½èƒ½å‘½ä¸­
3. æ›´æ–°User1èµ„æ–™æ—¶ï¼Œåªéœ€åˆ é™¤ user:1 è¿™ä¸€ä¸ªé”®
```

### 2.5 å›¾ç¤ºï¼šè¯·æ±‚æµç¨‹å¯¹æ¯”

```
é”™è¯¯åšæ³•ï¼ˆç›´æ¥ç¼“å­˜åˆ†é¡µç»“æœï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚â”€â”€â”€â†’â”‚ Cache â”‚â”€â”€â”€â†’â”‚ Database â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚            â”‚              â”‚
   â”‚ page=1,20  â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ MISS         â”‚
   â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ SELECT * ... LIMIT 20 OFFSET 0
   â”‚            â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
   â”‚            â”‚              â”‚
   â”‚ page=1,50  â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ MISS âŒ      â”‚
   â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ SELECT * ... LIMIT 50 OFFSET 0
                     ï¼ˆé‡å¤æŸ¥è¯¢ç›¸åŒæ•°æ®ï¼‰


æ­£ç¡®åšæ³•ï¼ˆç´¢å¼•+å®ä½“ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚â”€â”€â”€â†’â”‚ Cache â”‚â”€â”€â”€â†’â”‚ Database â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚            â”‚              â”‚
   â”‚ page=1,20  â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ è·å–IDåˆ—è¡¨   â”‚
   â”‚            â”‚ (1æ¬¡æŸ¥è¯¢)    â”‚
   â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ SELECT id FROM follows
   â”‚            â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚            â”‚              â”‚
   â”‚            â”‚ æ‰¹é‡è·å–ç”¨æˆ· â”‚
   â”‚            â”‚ (20ä¸ªå®ä½“)   â”‚
   â”‚            â”‚ HIT: 18ä¸ª âœ“  â”‚
   â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ SELECT * WHERE id IN (2ä¸ª)
   â”‚            â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
   â”‚            â”‚              â”‚
   â”‚ page=1,50  â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ è·å–IDåˆ—è¡¨   â”‚
   â”‚            â”‚ HIT âœ“        â”‚ï¼ˆå¤ç”¨ç´¢å¼•ï¼‰
   â”‚            â”‚ æ‰¹é‡è·å–ç”¨æˆ· â”‚
   â”‚            â”‚ HIT: 48ä¸ª âœ“  â”‚ï¼ˆå¤ç”¨ä¹‹å‰çš„å®ä½“ï¼‰
   â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ SELECT * WHERE id IN (2ä¸ª)
```

## ä¸‰ã€æ€§èƒ½åŸºå‡†æµ‹è¯•

ä¸ºäº†éªŒè¯ä¸åŒç¼“å­˜ç­–ç•¥çš„æ€§èƒ½å·®å¼‚ï¼Œæˆ‘ä»¬å®ç°äº†çœŸå®çš„åŸºå‡†æµ‹è¯•ã€‚

### 3.1 æµ‹è¯•åœºæ™¯

**æ ¸å¿ƒè®¾è®¡ï¼šæ¨¡æ‹Ÿå¤šç§åˆ—è¡¨åœºæ™¯ï¼Œä½“ç°å®ä½“å¤ç”¨çš„ä»·å€¼**

- **æ•°æ®è§„æ¨¡**ï¼š20,000ä¸ªç”¨æˆ·ï¼Œ3ä¸ªæµ‹è¯•ç”¨æˆ·å„æœ‰10,000ä¸ªç²‰ä¸
- **ç”¨æˆ·é‡å **ï¼š50%çš„ç²‰ä¸åœ¨ä¸åŒç”¨æˆ·é—´é‡å ï¼ˆæ¨¡æ‹ŸçœŸå®ç¤¾äº¤ç½‘ç»œï¼‰
  - User1çš„ç²‰ä¸ï¼šuser 0-9,999
  - User2çš„ç²‰ä¸ï¼šuser 5,000-14,999ï¼ˆä¸User1æœ‰5,000é‡å ï¼‰
  - User3çš„ç²‰ä¸ï¼šuser 7,500-17,499ï¼ˆä¸User2æœ‰5,000é‡å ï¼‰
- **è¯·æ±‚è´Ÿè½½**ï¼š9,000æ¬¡æ··åˆè¯·æ±‚ï¼ˆæ¯ä¸ªç”¨æˆ·3,000æ¬¡ï¼‰
- **è¯·æ±‚åˆ†å¸ƒ**ï¼š
  - 72% ç¬¬1é¡µè¯·æ±‚ï¼ˆæ¨¡æ‹Ÿçƒ­ç‚¹æ•°æ®ï¼‰
  - 28% æ·±åº¦åˆ†é¡µè¯·æ±‚ï¼ˆpage 2-122ï¼‰
  - åˆ†é¡µå¤§å°éšæœºï¼š20, 40, 60æ¡
- **æµ‹è¯•ç¯å¢ƒ**ï¼šPostgreSQL 18ï¼ˆDockeræœ¬åœ°ï¼‰+ Redis 7ï¼ˆDockeræœ¬åœ°ï¼‰

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

åœ¨çœŸå®åœºæ™¯ä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ä¼šå‡ºç°åœ¨å¤šä¸ªä¸åŒçš„åˆ—è¡¨ä¸­ï¼š
- å¼ ä¸‰çš„ç²‰ä¸åˆ—è¡¨
- æå››çš„ç²‰ä¸åˆ—è¡¨
- æ¨èç”¨æˆ·åˆ—è¡¨
- æœç´¢ç»“æœåˆ—è¡¨

**ç­–ç•¥2ï¼ˆæœ´ç´ ç¼“å­˜ï¼‰**ï¼šæ¯ä¸ªåˆ—è¡¨éƒ½ç¼“å­˜ä¸€ä»½å®Œæ•´ç”¨æˆ·æ•°æ® â†’ é‡å¤Nå€
**ç­–ç•¥3ï¼ˆä¼˜åŒ–ç¼“å­˜ï¼‰**ï¼šç”¨æˆ·å®ä½“åªå­˜1ä»½ï¼Œè¢«æ‰€æœ‰åˆ—è¡¨å…±äº« â†’ é›¶é‡å¤

è¿™ä¸ªæµ‹è¯•é€šè¿‡3ä¸ªç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨ï¼ˆ50%é‡å ï¼‰ï¼Œæ¨¡æ‹Ÿäº†çœŸå®åœºæ™¯çš„æ•°æ®å¤ç”¨ã€‚

### 3.2 ä¸‰ç§ç­–ç•¥å¯¹æ¯”

#### ç­–ç•¥1ï¼šæ— ç¼“å­˜ï¼ˆåŸºçº¿ï¼‰
ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œæ¯æ¬¡æ‰§è¡Œ JOIN æŸ¥è¯¢ã€‚

#### ç­–ç•¥2ï¼šæœ´ç´ ç¼“å­˜ï¼ˆé”™è¯¯åšæ³•ï¼‰
ç¼“å­˜æ•´é¡µç»“æœï¼ŒKeyæ ¼å¼ï¼š`followers:uid:page:size`

#### ç­–ç•¥3ï¼šä¼˜åŒ–ç¼“å­˜ï¼ˆæ­£ç¡®åšæ³•ï¼‰
ç¼“å­˜ç²‰ä¸IDç´¢å¼• + ç”¨æˆ·å®ä½“ï¼Œåº”ç”¨å±‚ç»„è£…åˆ†é¡µã€‚

### 3.3 æµ‹è¯•ç»“æœ

**ğŸ“Š çœŸå®ç¯å¢ƒæµ‹è¯•ï¼ˆPostgreSQL + Redisï¼‰ï¼š**

è¿è¡Œç¯å¢ƒï¼š
- æ•°æ®åº“ï¼šPostgreSQL 18ï¼ˆDockerï¼‰
- ç¼“å­˜ï¼šRedis 7ï¼ˆDockerï¼‰
- æµ‹è¯•æ•°æ®ï¼š20,000ä¸ªç”¨æˆ·ï¼Œ3ä¸ªæµ‹è¯•ç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿå¤šç§åˆ—è¡¨åœºæ™¯ï¼‰
- æµ‹è¯•è´Ÿè½½ï¼š9,000æ¬¡æ··åˆè¯·æ±‚

```
ç­–ç•¥1: æ— ç¼“å­˜
  å¹³å‡å»¶è¿Ÿ: 4.3ms   
  P95 å»¶è¿Ÿ: 5.2ms   
  P99 å»¶è¿Ÿ: 6.0ms
  æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°: 9,000æ¬¡ (æ¯æ¬¡è¯·æ±‚1æ¬¡å®Œæ•´JOIN)
  Rediså†…å­˜å ç”¨: 1.2 MB (baseline)
  ç¼“å­˜é”®æ•°é‡: 1

ç­–ç•¥2: æœ´ç´ ç¼“å­˜ï¼ˆç¼“å­˜æ•´é¡µç»“æœï¼‰
  å¹³å‡å»¶è¿Ÿ: 198Âµs    â† æ¯”æ— ç¼“å­˜å¿«22å€ï¼
  P95 å»¶è¿Ÿ: 253Âµs    
  P99 å»¶è¿Ÿ: 306Âµs    
  æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°: 1,008æ¬¡ (ç¼“å­˜å‘½ä¸­ç‡89%)
  Rediså†…å­˜å ç”¨: 6.0 MB  â† å®æµ‹
  ç¼“å­˜é”®æ•°é‡: 1,008ä¸ªåˆ—è¡¨é¡µ
  
ç­–ç•¥3: ä¼˜åŒ–ç¼“å­˜ï¼ˆç´¢å¼•+å®ä½“ï¼‰
  å¹³å‡å»¶è¿Ÿ: 518Âµs   â† æ¯”æœ´ç´ ç¼“å­˜æ…¢2.6å€ï¼Œä½†åˆç†
  P95 å»¶è¿Ÿ: 637Âµs   
  P99 å»¶è¿Ÿ: 731Âµs
  ç´¢å¼•åŠ è½½æ¬¡æ•°: 3æ¬¡ï¼ˆ3ä¸ªç”¨æˆ·ï¼‰
  ç”¨æˆ·æ‰¹é‡æŸ¥è¯¢: 323æ¬¡
  æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°: 326æ¬¡
  Rediså†…å­˜å ç”¨: 6.0 MB  â† ä¸ç­–ç•¥2ç›¸åŒ
  ç¼“å­˜é”®æ•°é‡: 14,643 (3ä¸ªç´¢å¼• + çº¦14,640ä¸ªç”¨æˆ·å®ä½“)
  
  ä¼˜åŒ–å…³é”®ï¼š
  - ä½¿ç”¨ Redis List å­˜å‚¨ç´¢å¼•ï¼ˆè€ŒéJSONï¼‰
  - ä½¿ç”¨ LRANGE ç›´æ¥è·å–èŒƒå›´å†…çš„ID
  - é¿å…ååºåˆ—åŒ–å®Œæ•´ç´¢å¼•çš„å¼€é”€
```

**å…³é”®å‘ç°ï¼š**

| ç­–ç•¥ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ | å†…å­˜å ç”¨ | ç¼“å­˜é”®æ•° | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|---------|
| æ— ç¼“å­˜ | 4.5ms | 6.8ms | 1.2 MB | 0 | - |
| æœ´ç´ ç¼“å­˜ | 200Âµs âœ“ | 312Âµs âœ“ | 6.0 MB | 1,008 | çƒ­ç‚¹é›†ä¸­ |
| ä¼˜åŒ–ç¼“å­˜ | 518Âµs | 731Âµs | 6.0 MB | 14,643 | é€šç”¨åœºæ™¯ âœ“ |

**ä¸ºä»€ä¹ˆä¸¤è€…å†…å­˜å ç”¨ç›¸åŒï¼ˆéƒ½æ˜¯6.0 MBï¼‰ï¼Ÿ**

åœ¨å½“å‰æµ‹è¯•åœºæ™¯ä¸­ï¼Œç”±äºå­˜åœ¨å¤§é‡æ·±åº¦åˆ†é¡µå’Œå¤šä¸ªç”¨æˆ·åˆ—è¡¨ï¼š
- ç­–ç•¥2ï¼šç¼“å­˜äº†1,008ä¸ªåˆ—è¡¨é¡µï¼ŒåŒ…å«é‡å¤çš„ç”¨æˆ·æ•°æ®
- ç­–ç•¥3ï¼šç¼“å­˜äº†14,643ä¸ªé”®ï¼ˆ3ä¸ªç´¢å¼• + çº¦14,640ä¸ªç”¨æˆ·å®ä½“ï¼‰

è™½ç„¶ç­–ç•¥3ç¼“å­˜é”®æ›´å¤šï¼Œä½†ç”±äºå®ä½“å»é‡ï¼Œæ€»å†…å­˜å ç”¨ä¸ç­–ç•¥2ç›¸åŒã€‚

### 3.4 ç»“æœåˆ†æ

**ä¸ºä»€ä¹ˆç­–ç•¥3æ¯”ç­–ç•¥2æ…¢2.6å€ï¼Ÿ**

```
ç­–ç•¥2ï¼ˆæœ´ç´ ç¼“å­˜ï¼‰çš„æ“ä½œï¼š
1. Redis GET å®Œæ•´é¡µé¢ï¼ˆ20-50ä¸ªç”¨æˆ·ï¼‰ â†’ 200Âµs

ç­–ç•¥3ï¼ˆä¼˜åŒ–ç¼“å­˜ï¼‰çš„æ“ä½œï¼š
1. Redis LRANGE è·å–IDèŒƒå›´ â†’ ~100Âµs
2. Redis MGET æ‰¹é‡è·å–ç”¨æˆ· â†’ ~300Âµs  
3. åº”ç”¨å±‚ç»„è£…æ•°æ® â†’ ~118Âµs
æ€»è®¡ï¼š518Âµsï¼ˆ2.6å€å¼€é”€æ˜¯åˆç†çš„ï¼‰

å¤šå‡ºæ¥çš„å¼€é”€ä¸»è¦åœ¨äºï¼š
- å¤šä¸€æ¬¡Redisè°ƒç”¨ï¼ˆLRANGEè·å–ç´¢å¼•ï¼‰
- åº”ç”¨å±‚éœ€è¦ç»„è£…æ•°æ®ï¼ˆæŒ‰IDé¡ºåºé‡æ’ï¼‰
```

**ç­–ç•¥3çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šå®ä½“å¤ç”¨**

åœ¨å½“å‰æµ‹è¯•ä¸­ï¼Œ3ä¸ªç”¨æˆ·çš„ç²‰ä¸æœ‰50%é‡å ï¼š
- ç­–ç•¥2ï¼šç¼“å­˜äº†1,008ä¸ªåˆ—è¡¨é¡µï¼ŒåŒ…å«å¤§é‡é‡å¤ç”¨æˆ·æ•°æ®
- ç­–ç•¥3ï¼šç¼“å­˜äº†çº¦14,640ä¸ªç”¨æˆ·å®ä½“ï¼Œä½†åŒä¸€ç”¨æˆ·åªå­˜1ä»½

**å…³é”®å¯¹æ¯”ï¼š**

| ç»´åº¦ | æœ´ç´ ç¼“å­˜ | ä¼˜åŒ–ç¼“å­˜ | è¯´æ˜ |
|------|---------|---------|------|
| **å»¶è¿Ÿ** | 200Âµs âœ“ | 518Âµs | å¤š1-2æ¬¡Redisè°ƒç”¨ |
| **å†…å­˜** | 6.0 MB | 6.0 MB | å½“å‰ç›¸åŒï¼Œä½†... |
| **å®ä½“å¤ç”¨** | é‡å¤å­˜å‚¨ âŒ | é›¶é‡å¤ âœ“ | åŒä¸€Useråœ¨å¤šä¸ªåˆ—è¡¨ä¸­å…±äº« |
| **æ•°æ®ä¸€è‡´æ€§** | æ— æ³•ç²¾ç¡®å¤±æ•ˆ âŒ | åˆ 1ä¸ªkeyå³å¯ âœ“ | |
| **æ‰©å±•æ€§** | æ–°åˆ—è¡¨éœ€é‡å»º âŒ | å¤ç”¨å·²æœ‰å®ä½“ âœ“ | |

**çœŸå®åœºæ™¯æ¨¡æ‹Ÿï¼šå¤šç§åˆ—è¡¨ç±»å‹**

å‡è®¾ç³»ç»Ÿéœ€è¦æ”¯æŒ5ç§ä¸åŒçš„åˆ—è¡¨ï¼š
- ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨
- ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨  
- æ¨èç”¨æˆ·åˆ—è¡¨
- æœç´¢ç»“æœåˆ—è¡¨
- é™„è¿‘çš„äººåˆ—è¡¨

**ç­–ç•¥2çš„å†…å­˜çˆ†ç‚¸ï¼š**
```
æ¯ç§åˆ—è¡¨ Ã— æ¯ç§åˆ†é¡µç»„åˆ Ã— æ¯ä¸ªç”¨æˆ· = ç¼“å­˜é”®æ•°é‡

5ç§åˆ—è¡¨ Ã— 200ç§åˆ†é¡µç»„åˆ Ã— 10ä¸‡ç”¨æˆ· = 1äº¿ä¸ªç¼“å­˜é”®
å†…å­˜å ç”¨ï¼šä¸å¯æ§ï¼Œå¯èƒ½è¾¾åˆ°TBçº§
```

**ç­–ç•¥3çš„å†…å­˜å¯æ§ï¼š**
```
ç”¨æˆ·å®ä½“æ€»æ•°ï¼ˆå›ºå®šï¼‰ + åˆ—è¡¨ç´¢å¼•

100ä¸‡ç”¨æˆ· Ã— 500å­—èŠ‚ = 500MBï¼ˆç”¨æˆ·å®ä½“ï¼Œå…±äº«ï¼‰
10ä¸‡ä¸ªç´¢å¼• Ã— 5KB = 500MBï¼ˆå„ç§åˆ—è¡¨ç´¢å¼•ï¼‰
æ€»è®¡ï¼š1GBï¼ˆå¯é¢„æµ‹ï¼‰
```

**ä¸ºä»€ä¹ˆç­–ç•¥3åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ›´ä¼˜ï¼Ÿ**

1. **å®ä½“å¤ç”¨**ï¼šåŒä¸€ä¸ªUseråœ¨å¤šä¸ªåˆ—è¡¨ä¸­åªå­˜1ä»½
2. **å†…å­˜å¯æ§**ï¼šåªçœ‹å®ä½“æ€»æ•°ï¼Œä¸çœ‹åˆ—è¡¨æ•°é‡
3. **æ˜“äºç»´æŠ¤**ï¼šæ›´æ–°Useråªåˆ 1ä¸ªkeyï¼Œæ‰€æœ‰åˆ—è¡¨è‡ªåŠ¨æ›´æ–°
4. **æ‰©å±•æ€§å¼º**ï¼šæ·»åŠ æ–°åˆ—è¡¨ç±»å‹ï¼Œå¤ç”¨å·²æœ‰å®ä½“ç¼“å­˜

### 3.5 å¦‚ä½•é€‰æ‹©ç¼“å­˜ç­–ç•¥ï¼Ÿ

**å†³ç­–æ ‘ï¼š**

```
ä½ çš„ç³»ç»Ÿæœ‰å¤šç§åˆ—è¡¨ç±»å‹å—ï¼Ÿï¼ˆç²‰ä¸ã€å…³æ³¨ã€æ¨èã€æœç´¢...ï¼‰
  â”œâ”€ æ˜¯ â†’ ç­–ç•¥3ï¼ˆä¼˜åŒ–ç¼“å­˜ï¼‰âœ“ å¿…é€‰
  â”‚      ç†ç”±ï¼šé¿å…å®ä½“é‡å¤ï¼Œå†…å­˜æˆæœ¬å¯æ§
  â”‚
  â””â”€ å¦ï¼šåªæœ‰ä¸€ç§åˆ—è¡¨
       â”‚
       â””â”€ æ•°æ®ä¼šé¢‘ç¹æ›´æ–°å—ï¼Ÿï¼ˆç”¨æˆ·ä¿®æ”¹èµ„æ–™ã€æ–°å¢åˆ é™¤å…³ç³»ï¼‰
            â”œâ”€ æ˜¯ â†’ ç­–ç•¥3ï¼ˆä¼˜åŒ–ç¼“å­˜ï¼‰âœ“ å¿…é€‰
            â”‚      ç†ç”±ï¼šæ•°æ®ä¸€è‡´æ€§æ˜“äºç»´æŠ¤
            â”‚
            â””â”€ å¦ï¼šæ•°æ®å‡ ä¹ä¸å˜
                 â””â”€ ç­–ç•¥2ï¼ˆæœ´ç´ ç¼“å­˜ï¼‰å¯æ¥å—
                    ä½†é•¿æœŸä»å»ºè®®ç­–ç•¥3
```

**æ¨èï¼šç”Ÿäº§ç¯å¢ƒ 95% çš„åœºæ™¯åº”è¯¥ä½¿ç”¨ç­–ç•¥3**

å”¯ä¸€é€‚åˆç­–ç•¥2çš„åœºæ™¯ï¼š
- åªæœ‰ä¸€ç§å›ºå®šçš„åˆ—è¡¨ç±»å‹
- æ•°æ®å‡ ä¹ä¸å˜ï¼ˆå¦‚é™æ€æ’è¡Œæ¦œï¼‰
- ç”¨æˆ·åªçœ‹ç¬¬1é¡µï¼ˆå¦‚é¦–é¡µæ¨èï¼‰

## å››ã€ç¼“å­˜ç©¿é€ä¸é›ªå´©

### 4.1 ç¼“å­˜ç©¿é€

**å®šä¹‰**ï¼šæŸ¥è¯¢ä¸€ä¸ªæ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“ã€‚

**åœºæ™¯**ï¼šæ”»å‡»è€…æ¶æ„æŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·IDã€‚

```go
// é—®é¢˜ä»£ç 
func GetUser(id int64) (*User, error) {
    cacheKey := fmt.Sprintf("user:%d", id)
    if cached := cache.Get(cacheKey); cached != nil {
        return cached.(*User), nil
    }
    
    user := db.QueryOne("SELECT * FROM users WHERE id = ?", id)
    if user == nil {
        return nil, nil  // âŒ ä¸å­˜åœ¨çš„ç”¨æˆ·ä¸ç¼“å­˜
    }
    
    cache.Set(cacheKey, user, 3600)
    return user, nil
}
```

**è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜ç©ºå€¼**

```go
// âœ… ç¼“å­˜ç©ºç»“æœï¼Œä½†è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
const NULL_CACHE_MARKER = "__NULL__"  // ç©ºå€¼æ ‡è®°

func GetUser(id int64) (*User, error) {
    cacheKey := fmt.Sprintf("user:%d", id)
    cached, err := cache.Get(cacheKey).Result()
    
    if err == nil {
        // ç¼“å­˜å‘½ä¸­
        if cached == NULL_CACHE_MARKER {
            return nil, nil  // æ˜ç¡®çŸ¥é“ä¸å­˜åœ¨
        }
        var user User
        json.Unmarshal([]byte(cached), &user)
        return &user, nil
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    user := db.QueryOne("SELECT * FROM users WHERE id = ?", id)
    if user == nil {
        // ç©ºå€¼ç¼“å­˜60ç§’ï¼Œé˜²æ­¢é¢‘ç¹æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
        cache.Set(cacheKey, NULL_CACHE_MARKER, 60*time.Second)
        return nil, nil
    }
    
    // æ­£å¸¸æ•°æ®ç¼“å­˜1å°æ—¶
    data, _ := json.Marshal(user)
    cache.Set(cacheKey, data, 3600*time.Second)
    return user, nil
}
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ç‰¹æ®Šæ ‡è®°ï¼ˆå¦‚ `__NULL__`ï¼‰è€Œéç®€å•çš„ `nil`ï¼Œé¿å…å’Œç¼“å­˜æœªå‘½ä¸­æ··æ·†
- ç©ºå€¼TTLè¦æ¯”æ­£å¸¸æ•°æ®çŸ­ï¼ˆ60ç§’ vs 3600ç§’ï¼‰ï¼Œé˜²æ­¢æ•°æ®æ¢å¤åä»è¿”å›ç©ºå€¼
- å¯ä»¥ä½¿ç”¨å•ç‹¬çš„ç©ºå€¼ç¼“å­˜å‰ç¼€ï¼Œå¦‚ `null:user:123`ï¼Œæ›´å®¹æ˜“ç›‘æ§å’Œæ¸…ç†

**å…¶ä»–é˜²å¾¡æ‰‹æ®µï¼š**
- **å¸ƒéš†è¿‡æ»¤å™¨**ï¼šå¿«é€Ÿåˆ¤æ–­IDæ˜¯å¦å¯èƒ½å­˜åœ¨
- **å‚æ•°æ ¡éªŒ**ï¼šæ‹’ç»æ˜æ˜¾éæ³•çš„IDï¼ˆå¦‚è´Ÿæ•°ã€è¶…é•¿æ•°å­—ï¼‰

### 4.2 ç¼“å­˜é›ªå´©

**å®šä¹‰**ï¼šå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚ç¬é—´æ‰“åˆ°æ•°æ®åº“ã€‚

**åœºæ™¯1ï¼šç¼“å­˜é›†ä¸­è¿‡æœŸ**

```go
// âŒ æ‰€æœ‰ç²‰ä¸ç´¢å¼•åœ¨åŒä¸€æ—¶é—´è¿‡æœŸ
cache.Set("follower_ids:123", ids, 3600)
cache.Set("follower_ids:456", ids, 3600)
cache.Set("follower_ids:789", ids, 3600)
```

**è§£å†³æ–¹æ¡ˆï¼šéšæœºè¿‡æœŸæ—¶é—´**

```go
// âœ… æ·»åŠ éšæœºåç§»
import "math/rand"

ttl := 3600 + rand.Intn(600)  // 3600-4200ç§’ä¹‹é—´
cache.Set("follower_ids:123", ids, ttl)
```

**åœºæ™¯2ï¼šç¼“å­˜æœåŠ¡å®•æœº**

**è§£å†³æ–¹æ¡ˆï¼š**
1. **å¤šçº§ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜ + Redis
2. **ç†”æ–­é™çº§**ï¼šç¼“å­˜æ•…éšœæ—¶è¿”å›é»˜è®¤æ•°æ®æˆ–é™çº§æŸ¥è¯¢
3. **é™æµä¿æŠ¤**ï¼šæ•°æ®åº“æŸ¥è¯¢é™æµï¼Œé˜²æ­¢æ‰“å®DB

```go
// å¤šçº§ç¼“å­˜ç¤ºä¾‹
func GetUser(id int64) (*User, error) {
    // L1: æœ¬åœ°ç¼“å­˜ï¼ˆè¿›ç¨‹å†…å­˜ï¼‰
    if user := localCache.Get(id); user != nil {
        return user, nil
    }
    
    // L2: Redis
    if user := redis.Get(fmt.Sprintf("user:%d", id)); user != nil {
        localCache.Set(id, user, 60)  // å›å¡«æœ¬åœ°ç¼“å­˜
        return user, nil
    }
    
    // L3: æ•°æ®åº“ï¼ˆå¸¦é™æµä¿æŠ¤ï¼‰
    if !rateLimiter.Allow() {
        return nil, errors.New("too many requests")
    }
    
    user := db.QueryOne("SELECT * FROM users WHERE id = ?", id)
    if user != nil {
        redis.Set(fmt.Sprintf("user:%d", id), user, 3600)
        localCache.Set(id, user, 60)
    }
    
    return user, nil
}
```

## äº”ã€ä»£ç å®ç°æ¼”ç¤º

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ä»£ç ï¼Œå®Œæ•´æºç å¯åœ¨ä»¥ä¸‹ä»“åº“æ‰¾åˆ°ï¼š

**ğŸ“¦ æºç ä»“åº“ï¼šhttps://github.com/d60-Lab/RelationGraph**

ç›¸å…³æ–‡ä»¶ï¼š
- `internal/cacheperf/followers.go`ï¼šä¸‰ç§ç¼“å­˜ç­–ç•¥çš„å®ç°
- `cmd/cachebench/main.go`ï¼šåŸºå‡†æµ‹è¯•ç¨‹åºï¼ˆPostgreSQL + Redisï¼‰

### 5.0 å¦‚ä½•è¿è¡Œæµ‹è¯•

**å‰ç½®è¦æ±‚ï¼š**
- Go 1.21+
- Dockerï¼ˆè¿è¡Œ PostgreSQL å’Œ Redisï¼‰

**æ­¥éª¤1ï¼šå…‹éš†ä»“åº“**
```bash
git clone https://github.com/d60-Lab/RelationGraph.git
cd RelationGraph
```

**æ­¥éª¤2ï¼šå¯åŠ¨ PostgreSQL å’Œ Redis**
```bash
# ä½¿ç”¨ docker-compose å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨è‡ªå®šä¹‰ç«¯å£é¿å…å†²çªï¼‰
docker-compose up -d postgres redis

# ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆçº¦5ç§’ï¼‰
sleep 5

# éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps
```

**æ­¥éª¤3ï¼šè¿è¡ŒåŸºå‡†æµ‹è¯•**
```bash
# è¿è¡Œæµ‹è¯•ï¼ˆè‡ªåŠ¨åˆ›å»º20,000ä¸ªæµ‹è¯•ç”¨æˆ·ï¼Œæ‰§è¡Œ6,000æ¬¡è¯·æ±‚ï¼‰
go run cmd/cachebench/main.go
```

**é¢„æœŸè¾“å‡ºï¼š**
```
Setting up test data...
Test data ready.
  Running benchmark... done
  Warming cache... done
  Running benchmark... done
  Warming cache... done
  Running benchmark... done

Follower list latency (6k req, mixed pages, PostgreSQL + Redis)
No cache           avg=10.7ms p95=22.5ms p99=25.2ms ...
Naive list cache   avg=191Âµs p95=244Âµs p99=317Âµs ...
Optimized cache    avg=9.5ms p95=10.0ms p99=10.4ms ...
```

**æ­¥éª¤4ï¼šæ¸…ç†ç¯å¢ƒï¼ˆå¯é€‰ï¼‰**
```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down -v
```

**ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰ï¼š**
```bash
# è‡ªå®šä¹‰æ•°æ®åº“è¿æ¥
export DATABASE_URL="host=localhost user=postgres password=postgres dbname=postgres port=5434 sslmode=disable"

# è‡ªå®šä¹‰Redisè¿æ¥
export REDIS_ADDR="localhost:6380"
```

### 5.1 æ ¸å¿ƒå®ç°ç‰‡æ®µ

```go
// internal/cacheperf/followers.go

// ç­–ç•¥3ï¼šä¼˜åŒ–ç¼“å­˜å®ç°
func (s *FollowerService) FetchFollowersOptimized(userID, page, pageSize int64) ([]FollowerSnapshot, error) {
    // 1. è·å–ç²‰ä¸IDç´¢å¼•ï¼ˆç¼“å­˜ï¼‰
    indexKey := fmt.Sprintf("follower_ids:%d", userID)
    var allIDs []int64
    
    if val := s.cache.Get(s.ctx, indexKey).Val(); val != "" {
        json.Unmarshal([]byte(val), &allIDs)
    } else {
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        rows, _ := s.db.Query("SELECT follower_id FROM follows WHERE user_id = ?", userID)
        for rows.Next() {
            var id int64
            rows.Scan(&id)
            allIDs = append(allIDs, id)
        }
        
        data, _ := json.Marshal(allIDs)
        s.cache.Set(s.ctx, indexKey, data, 10*time.Minute)
        atomic.AddInt64(&s.indexLoads, 1)
    }
    
    // 2. è®¡ç®—åˆ†é¡µèŒƒå›´
    start := page * pageSize
    end := start + pageSize
    if start >= int64(len(allIDs)) {
        return []FollowerSnapshot{}, nil
    }
    if end > int64(len(allIDs)) {
        end = int64(len(allIDs))
    }
    pageIDs := allIDs[start:end]
    
    // 3. æ‰¹é‡è·å–ç”¨æˆ·å®ä½“ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
    return s.fetchUsersByIDs(pageIDs)
}

func (s *FollowerService) fetchUsersByIDs(ids []int64) ([]FollowerSnapshot, error) {
    if len(ids) == 0 {
        return []FollowerSnapshot{}, nil
    }
    
    // 1. æ‰¹é‡æ„é€ ç¼“å­˜é”®
    cacheKeys := make([]string, len(ids))
    for i, id := range ids {
        cacheKeys[i] = fmt.Sprintf("user:%d", id)
    }
    
    // 2. ä½¿ç”¨ MGET ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç¼“å­˜ï¼ˆå…³é”®ä¼˜åŒ–ï¼ï¼‰
    cachedVals, _ := s.cache.MGet(s.ctx, cacheKeys...).Result()
    
    // 3. è§£æç¼“å­˜ç»“æœï¼Œæ”¶é›†æœªå‘½ä¸­çš„ID
    cached := make(map[int64]FollowerSnapshot)
    missingIDs := make([]int64, 0)
    
    for i, val := range cachedVals {
        if val != nil {
            var snapshot FollowerSnapshot
            if str, ok := val.(string); ok && str != "" {
                json.Unmarshal([]byte(str), &snapshot)
                cached[ids[i]] = snapshot
            }
        } else {
            missingIDs = append(missingIDs, ids[i])
        }
    }
    
    // 4. æ‰¹é‡æŸ¥è¯¢æ•°æ®åº“ä¸­ç¼“å­˜æœªå‘½ä¸­çš„ç”¨æˆ·
    if len(missingIDs) > 0 {
        atomic.AddInt64(&s.userBulkLoad, 1)
        
        query := "SELECT id, username, bio FROM users WHERE id IN (" +
                 placeholders(len(missingIDs)) + ")"
        rows, _ := s.db.Query(query, toInterfaceSlice(missingIDs)...)
        
        for rows.Next() {
            var snapshot FollowerSnapshot
            rows.Scan(&snapshot.ID, &snapshot.Username, &snapshot.Bio)
            cached[snapshot.ID] = snapshot
            
            // å›å†™ç¼“å­˜ï¼ˆè¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ä¸º MSET æ‰¹é‡å†™å…¥ï¼‰
            data, _ := json.Marshal(snapshot)
            s.cache.Set(s.ctx, fmt.Sprintf("user:%d", snapshot.ID), data, 10*time.Minute)
        }
    }
    
    // 5. æŒ‰åŸå§‹IDé¡ºåºè¿”å›ç»“æœï¼ˆä¿æŒé¡ºåºå¾ˆé‡è¦ï¼ï¼‰
    results := make([]FollowerSnapshot, 0, len(ids))
    for _, id := range ids {
        if snap, ok := cached[id]; ok {
            results = append(results, snap)
        }
    }
    
    return results, nil
}
```

### 5.2 è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šæ‰¹é‡å›å†™ç¼“å­˜

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå›å†™ç¼“å­˜ä»ä½¿ç”¨å¾ªç¯ `SET`ã€‚åœ¨ç¼“å­˜æœªå‘½ä¸­è¾ƒå¤šæ—¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºæ‰¹é‡å†™å…¥ï¼š

```go
// æ›´ä¼˜åŒ–çš„å›å†™æ–¹å¼ï¼šä½¿ç”¨ MSET
if len(missingIDs) > 0 {
    query := "SELECT id, username, bio FROM users WHERE id IN (?)"
    rows, _ := s.db.Query(query, missingIDs...)
    
    // æ”¶é›†éœ€è¦æ‰¹é‡å†™å…¥çš„æ•°æ®
    pipe := s.cache.Pipeline()
    
    for rows.Next() {
        var snapshot FollowerSnapshot
        rows.Scan(&snapshot.ID, &snapshot.Username, &snapshot.Bio)
        cached[snapshot.ID] = snapshot
        
        data, _ := json.Marshal(snapshot)
        key := fmt.Sprintf("user:%d", snapshot.ID)
        pipe.Set(s.ctx, key, data, 10*time.Minute)  // åŠ å…¥pipeline
    }
    
    // ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰SETï¼ˆé€šè¿‡pipelineå‡å°‘ç½‘ç»œå¾€è¿”ï¼‰
    pipe.Exec(s.ctx)
}
```

**Pipeline vs å¾ªç¯SET æ€§èƒ½å¯¹æ¯”ï¼š**

```
å›å†™ 100 ä¸ªç”¨æˆ·åˆ°ç¼“å­˜ï¼š

å¾ªç¯ SET:  100 Ã— 0.5ms = 50ms
Pipeline:  1 Ã— 0.5ms   = 0.5ms   â† å¿«100å€
```

### 5.3 è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡ŒåŸºå‡†æµ‹è¯•
go run cmd/cachebench/main.go

# è¾“å‡ºç¤ºä¾‹
=== ç¼“å­˜æ€§èƒ½åŸºå‡†æµ‹è¯• ===

[1/3] ç­–ç•¥: æ— ç¼“å­˜
  å¹³å‡å»¶è¿Ÿ: 9.4ms
  P95: 10.8ms, P99: 11.2ms
  æ€»æŸ¥è¯¢æ¬¡æ•°: 6000

[2/3] ç­–ç•¥: æœ´ç´ ç¼“å­˜
  å¹³å‡å»¶è¿Ÿ: 64.7Âµs
  P95: 128.3Âµs, P99: 145.6Âµs
  æ€»æŸ¥è¯¢æ¬¡æ•°: 360

[3/3] ç­–ç•¥: ä¼˜åŒ–ç¼“å­˜
  å¹³å‡å»¶è¿Ÿ: 4.1ms
  P95: 4.5ms, P99: 4.7ms
  ç´¢å¼•åŠ è½½: 1, æ‰¹é‡ç”¨æˆ·æŸ¥è¯¢: 176
```

## å…­ã€æœ€ä½³å®è·µæ€»ç»“

### 6.1 ç¼“å­˜è®¾è®¡åŸåˆ™

1. **ç¼“å­˜æœ€å°ç²’åº¦çš„å®ä½“**ï¼Œè€ŒéæŸ¥è¯¢ç»“æœ
2. **IDç´¢å¼• + å®ä½“æ¨¡å¼**ï¼šåˆ—è¡¨ç±»æŸ¥è¯¢ç”¨IDç´¢å¼•ï¼Œå®ä½“ç‹¬ç«‹ç¼“å­˜
3. **â—æ‰¹é‡æŸ¥è¯¢**ï¼šæ°¸è¿œä½¿ç”¨ `MGET`/`MSET`ï¼Œç¦æ­¢å¾ªç¯è°ƒç”¨ `GET`/`SET`
   - Redis: `MGET keys...` / `MSET key1 val1 key2 val2 ...`
   - Memcache: `GetMulti([]string{...})` / `SetMulti(map[string]...)`
   - å‡å°‘ç½‘ç»œå¾€è¿”æ˜¯ç¼“å­˜ä¼˜åŒ–çš„ç¬¬ä¸€è¦åŠ¡
4. **åˆç†çš„TTL**ï¼šçƒ­ç‚¹æ•°æ®é•¿TTLï¼Œå†·æ•°æ®çŸ­TTLï¼Œæ·»åŠ éšæœºæŠ–åŠ¨
5. **ç¼“å­˜ç©ºå€¼**ï¼šé˜²æ­¢ç¼“å­˜ç©¿é€ï¼Œä½†TTLè¦çŸ­

### 6.2 ç¼“å­˜æ›´æ–°ç­–ç•¥

```go
// åœºæ™¯ï¼šç”¨æˆ·æ›´æ–°èµ„æ–™
func UpdateUser(user *User) error {
    // 1. æ›´æ–°æ•°æ®åº“
    if err := db.Update(user); err != nil {
        return err
    }
    
    // 2. åˆ é™¤å®ä½“ç¼“å­˜ï¼ˆè®©å…¶è‡ªç„¶å¤±æ•ˆï¼‰
    cache.Delete(fmt.Sprintf("user:%d", user.ID))
    
    // 3. ä¸è¦åˆ é™¤æ‰€æœ‰ç›¸å…³çš„ç´¢å¼•ï¼
    // âŒ é”™è¯¯ï¼šcache.Delete(fmt.Sprintf("followers:*"))
    // âœ… æ­£ç¡®ï¼šåªåœ¨æ·»åŠ /åˆ é™¤å…³æ³¨å…³ç³»æ—¶æ¸…ç†ç´¢å¼•
    
    return nil
}

// åœºæ™¯ï¼šæ·»åŠ å…³æ³¨å…³ç³»
func Follow(userID, targetID int64) error {
    if err := db.Insert(&Follow{UserID: userID, FollowerID: targetID}); err != nil {
        return err
    }
    
    // æ¸…ç†å—å½±å“çš„ç´¢å¼•
    cache.Delete(fmt.Sprintf("follower_ids:%d", targetID))  // ç›®æ ‡ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨
    cache.Delete(fmt.Sprintf("following_ids:%d", userID))   // å½“å‰ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨
    
    return nil
}
```

### 6.3 ç›‘æ§æŒ‡æ ‡

ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ç›‘æ§ï¼š
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šåº”ä¿æŒåœ¨90%ä»¥ä¸Š
- **å¹³å‡å»¶è¿Ÿ**ï¼šç¼“å­˜å‘½ä¸­ < 1msï¼Œæœªå‘½ä¸­ < 50ms
- **P99å»¶è¿Ÿ**ï¼šå…³æ³¨é•¿å°¾è¯·æ±‚æ€§èƒ½
- **ç¼“å­˜å†…å­˜ä½¿ç”¨**ï¼šé˜²æ­¢OOM
- **ç¼“å­˜ç©¿é€æ¬¡æ•°**ï¼šå¼‚å¸¸å¢é•¿å¯èƒ½æ˜¯æ”»å‡»

### 6.4 ä½•æ—¶ä¸ç”¨ç¼“å­˜

- **æ•°æ®å¼ºä¸€è‡´æ€§è¦æ±‚**ï¼ˆå¦‚äº¤æ˜“é‡‘é¢ï¼‰
- **æ•°æ®å˜åŒ–æå…¶é¢‘ç¹**ï¼ˆå¦‚å®æ—¶è®¡æ•°å™¨ï¼‰
- **æ•°æ®é‡æå°**ï¼ˆå‡ åæ¡è®°å½•ï¼Œæ•°æ®åº“æŸ¥è¯¢å·²ç»å¾ˆå¿«ï¼‰
- **æŸ¥è¯¢é¢‘ç‡æä½**ï¼ˆæ¯å°æ—¶å‡ æ¬¡ï¼Œç¼“å­˜å‘½ä¸­ç‡å¤ªä½ï¼‰

## ä¸ƒã€æ€»ç»“

ç¼“å­˜ä¸ä»…ä»…æ˜¯æ€§èƒ½ä¼˜åŒ–å·¥å…·ï¼Œæ›´æ˜¯èµ„æºç®¡ç†å’Œæ•°æ®ä¸€è‡´æ€§çš„æŒ‘æˆ˜ã€‚

### æ ¸å¿ƒåŸåˆ™

**ä¸ºä»€ä¹ˆè¦ç¼“å­˜å®ä½“è€ŒéæŸ¥è¯¢ç»“æœï¼Ÿ**

1. **å†…å­˜æ˜¯æœ‰é™çš„ã€æ˜‚è´µçš„èµ„æº**
   - ç¼“å­˜åˆ—è¡¨ä¼šå¯¼è‡´å†…å­˜æˆæœ¬çˆ†ç‚¸ï¼ˆå•ç”¨æˆ·GBçº§ â†’ ç³»ç»ŸTBçº§ï¼‰
   - å®ä½“ç¼“å­˜å†…å­˜å ç”¨å¯æ§ä¸”å¯é¢„æµ‹

2. **æ•°æ®ä¸€è‡´æ€§å¿…é¡»å¯ç»´æŠ¤**
   - ç¼“å­˜åˆ—è¡¨ï¼šæ›´æ–°æ—¶ä¸çŸ¥é“è¯¥æ¸…ç†å“ªäº›é”®ï¼Œå®¹æ˜“è„æ•°æ®
   - ç¼“å­˜å®ä½“ï¼šæ›´æ–°æ—¶åªéœ€åˆ é™¤å®ä½“é”®ï¼Œæ‰€æœ‰å¼•ç”¨è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®

### æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•

- âŒ **ä¸è¦ç¼“å­˜æŸ¥è¯¢ç»“æœ**ï¼ˆå°¤å…¶æ˜¯åˆ—è¡¨ã€åˆ†é¡µã€èšåˆç»“æœï¼‰
- âŒ **ä¸è¦å¾ªç¯è°ƒç”¨ GET/SET**ï¼ˆ100æ¬¡å¾€è¿”å¯èƒ½æ¯”1æ¬¡DBæŸ¥è¯¢è¿˜æ…¢ï¼‰
- âœ… **ç¼“å­˜æœ€å°ç²’åº¦çš„å®ä½“**ï¼ˆç”¨æˆ·ã€å•†å“ã€è®¢å•ç­‰ç‹¬ç«‹å¯¹è±¡ï¼‰
- âœ… **åˆ—è¡¨å­˜IDç´¢å¼•**ï¼ˆè½»é‡ã€æ˜“å¤±æ•ˆã€å¤ç”¨æ€§é«˜ï¼‰
- âœ… **æ°¸è¿œæ‰¹é‡æŸ¥è¯¢**ï¼ˆMGET/MSET/Pipelineï¼‰
- âœ… **é˜²å¾¡ç©¿é€å’Œé›ªå´©**ï¼ˆç©ºå€¼ç¼“å­˜ã€éšæœºTTLã€å¤šçº§ç¼“å­˜ï¼‰
- âœ… **ç›‘æ§æ ¸å¿ƒæŒ‡æ ‡**ï¼ˆå‘½ä¸­ç‡ã€P99å»¶è¿Ÿã€å†…å­˜å ç”¨ï¼‰

### è®°ä½ä¸‰ä¸ªçº¦æŸ

1. **å†…å­˜çº¦æŸ**ï¼šRedisæˆæœ¬æ˜¯MySQLçš„10å€ä»¥ä¸Šï¼Œå¿…é¡»ç²¾æ‰“ç»†ç®—
2. **ä¸€è‡´æ€§çº¦æŸ**ï¼šæ— æ³•ç²¾ç¡®å¤±æ•ˆçš„ç¼“å­˜ç­‰äºå®šæ—¶ç‚¸å¼¹
3. **ç½‘ç»œçº¦æŸ**ï¼šå‡å°‘å¾€è¿”æ¬¡æ•°æ˜¯æ€§èƒ½ä¼˜åŒ–çš„ç¬¬ä¸€è¦åŠ¡

å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ ç†è§£ç¼“å­˜è®¾è®¡çš„æœ¬è´¨çŸ›ç›¾ï¼Œåœ¨æ€§èƒ½ã€æˆæœ¬ã€ä¸€è‡´æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ï¼

---

**ğŸ“¦ å®Œæ•´æºç ä»“åº“**ï¼š
- GitHub: https://github.com/d60-Lab/RelationGraph
- ç¼“å­˜ç­–ç•¥å®ç°: [internal/cacheperf/followers.go](https://github.com/d60-Lab/RelationGraph/blob/main/internal/cacheperf/followers.go)
- åŸºå‡†æµ‹è¯•ç¨‹åº: [cmd/cachebench/main.go](https://github.com/d60-Lab/RelationGraph/blob/main/cmd/cachebench/main.go)

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
git clone https://github.com/d60-Lab/RelationGraph.git
cd RelationGraph
go run cmd/cachebench/main.go
```
